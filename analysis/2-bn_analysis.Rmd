---
title: "2-bn_analysis"
author: "Bernard"
date: "2020-09-08"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
---

## Introduction

This is an example of a Bayesian network, with directed arcs. I only perform the analysis on a subset of provided variables.

### Import libraries

```{r, message=F, warning=F}

rm (list = ls())
# Helper
library (tidyverse)

# BN
library (bnlearn)

# Model
library (caret)

# Feature parallel
library (doParallel)

# Plot
library (Rgraphviz)

```

### Import data
```{r}

dat <- readRDS ("output/dat.RDS")

```

### Collapse variables

```{r}
dat <- dat %>%
  mutate (ppt_medn_base = (ppt_medn_aff_base + ppt_medn_naff_base)/2,
          ppt_uln_base = (ppt_uln_aff_base + ppt_uln_naff_base)/2,
          ppt_radn_base = (ppt_radn_aff_base + ppt_radn_naff_base)/2,
          ppt_neck_base = (ppt_neck_aff_base + ppt_neck_naff_base)/2,
          ppt_cts_base = (ppt_cts_aff_base + ppt_cts_naff_base)/2,
          ppt_ta_base = (ppt_ta_aff_base + ppt_ta_naff_base)/2) %>%
  select (-c(ppt_medn_aff_base:ppt_ta_naff_base)) 
```


### BN analysis

#### Create blacklist

```{r}

var.excl <- c(grep ("groc", names (dat), value = TRUE) ,
              grep ("mean", names (dat), value = TRUE),
              #grep ("base", names (dat), value = TRUE), 
              #"age", 
              #"pain_years", 
              #"pain_extent", 
              "aff_side" 
              #"emg"
              )
df.bn = as.data.frame (dat)[, !names (dat) %in% var.excl] %>%
  na.omit()

names (df.bn)[grepl ("years", names (df.bn))] <- "duration"
names (df.bn)[grepl ("extent", names (df.bn))] <- "area"
names (df.bn)[grepl ("cts_base", names (df.bn))] <- "ct_base"
names (df.bn)[grepl ("ppt", names (df.bn))] <- str_remove (names (df.bn)[grepl ("ppt", names (df.bn))], "ppt_")
names (df.bn)[grepl ("cts", names (df.bn))] <- str_remove (names (df.bn)[grepl ("cts", names (df.bn))], "cts_")
names (df.bn)[grepl ("worst", names (df.bn))] <- str_remove (names (df.bn)[grepl ("worst", names (df.bn))], "worst_")


df.bn$grp <- factor (df.bn$grp)

rx.var <- "grp"
demo.var = grep("age|duration|emg", colnames (df.bn), value = TRUE)
base.var = grep("_base", colnames (df.bn), value = TRUE)
mth1.var = grep("_1m", colnames (df.bn), value = TRUE)
mth3.var = grep("_3m", colnames (df.bn), value = TRUE)
mth6.var = grep("_6m", colnames (df.bn), value = TRUE)
outcome.var = grep("_12m", colnames (df.bn), value = TRUE)

pair_var <- expand.grid(from = names (df.bn),
                        to = names (df.bn)) %>%
  rownames_to_column()

tiers_keep <- pair_var %>%
  filter (!(grepl (paste0(outcome.var, collapse = "|"),from))) %>%
  filter (!(grepl (paste0(rx.var, collapse = "|"),to))) %>%
  filter (!(grepl (paste0(mth6.var, collapse = "|"), from) &
              grepl (paste0(c(demo.var, base.var, mth1.var, mth3.var), collapse = "|"),to))) %>%
  filter (!(grepl (paste0(mth3.var, collapse = "|"), from) &
              grepl (paste0(c(demo.var, base.var, mth1.var), collapse = "|"),to))) %>%
  filter (!(grepl (paste0(mth1.var, collapse = "|"), from) &
            grepl (paste0(c(demo.var, base.var), collapse = "|"),to))) %>%
  filter (!(grepl (paste0(base.var, collapse = "|"), from) &
          grepl (paste0(c(demo.var), collapse = "|"),to))) %>%
  filter (!(grepl (paste0(rx.var, collapse = "|"), from) &
          grepl (paste0(c(demo.var, base.var), collapse = "|"),to)))

bl <- anti_join(pair_var, tiers_keep, by = "rowname")  %>%
  filter (from != to) %>%
  select (from, to)


```


#### Build the final model using model averaging

```{r}
set.seed (123)
boot <- boot.strength(df.bn,
                      R = 200,
                      algorithm = "hc",
                      algorithm.args = list (blacklist = bl))

  

```

#### Get averaged model

"Underneath" the model is a complex mathematical relationship between each variables.The figure is meant to illustrate a complex model simply. Interpretation of a Bayesian Network model should be natural, the arrows reflect the direction of relationship. Example, `grp` influences `cts_func_12m` partly by `cts_func_1m` and partly directly. The thickness of the arrows reflect how common one would expect to find such a relationship should many separate experiments be collected. Whether the arrows reflect causal relationships really depend if we think these variables represent an exhaustive list of plausible biological causes. In this case, I do not think we can say it is causal, but we can certainly understand a complex relationship driving recovery.

```{r}

avg <-  averaged.network(boot, threshold = 0.5)
fit <-  bn.fit (avg, df.bn, method = "mle")
g <- strength.plot(avg, boot, shape = "ellipse", render = FALSE)
graph::nodeRenderInfo(g) = list(fontsize=18)
Rgraphviz::renderGraph(g)

```

#### Performance evaluation using nested cross validation. 
Not run yet.

Inner is bootstrap resampling for model averaging. 
Outer is bootstrap resampling k = 25 for performance evaluation.

```{r, echo = FALSE}

set.seed (1256)

flds <- createFolds(1:nrow(df.bn), 
                            k = 10, returnTrain = TRUE)
n_boot = 200
doParallel::registerDoParallel(7)

corr.df.list <- list()

for (k in seq_along(flds)) {
  
  train <-  df.bn [flds[[k]], ] %>% as.data.frame()
  test <- df.bn [-flds[[k]], ] %>% as.data.frame()
  
  doParallel::registerDoParallel(7)
  ############
  
  boot2 <- boot.strength(train,
                      R = 200,
                      algorithm = "hc",
                      algorithm.args = list (blacklist = bl))

  #############
  
  avg2 <-  averaged.network(boot2, threshold = 0.5)
  fit2 <-  bn.fit (avg2, train, method = "mle")
  
  num.var <- test %>%
    select_if (is.numeric) %>%
    names ()
  
  corr.df =  structure(numeric(length (num.var)), names = num.var)
  
  for (n in num.var) {
      corr.df[n] = cor(predict(fit2, 
                               data = test, 
                               node = n, 
                               method = "bayes-lw"),
                       test[n])
  }
  
  corr.df.list[[k]] <- corr.df
  

}

corr.df <- bind_cols (corr.df.list) %>%
  apply (1, mean)

names (corr.df) <- num.var

corr.df
```

# Save data

```{r, echo = FALSE}

save(avg, 
     bl, 
     rx.var,
     base.var,
     demo.var,
     mth1.var,
     mth3.var,
     mth6.var,
     outcome.var,
     boot, 
     corr.df, 
     df.bn, 
     fit,
     file = "output/bn_data.RData")

```




